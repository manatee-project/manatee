ARG BASE_IMAGE
FROM $BASE_IMAGE
ARG OUTPUTPATH
ARG JUPYTER_FILENAME
ARG USER_WORKSPACE
ARG CUSTOMTOKEN_CLOUDSTORAGE_PATH 

ENV OUTPUTPATH=$OUTPUTPATH
ENV JUPYTER_FILENAME=$JUPYTER_FILENAME
ENV CUSTOMTOKEN_CLOUDSTORAGE_PATH=$CUSTOMTOKEN_CLOUDSTORAGE_PATH

WORKDIR /home/jovyan
COPY $USER_WORKSAPCE/* ./

LABEL "tee.launch_policy.allow_env_override"="USER_TOKEN,EXECUTION_STAGE,DEPLOYMENT_ENV,PROJECT_ID"

ENTRYPOINT jupyter nbconvert --execute --to notebook --inplace $JUPYTER_FILENAME --ExecutePreprocessor.timeout=-1 --allow-errors \
    && hash=$(md5sum $JUPYTER_FILENAME | awk '{ print $1 }') \
    && ./gscp $JUPYTER_FILENAME $OUTPUTPATH \
    && ./gen_custom_token --nonce $hash \
    && ./gscp custom_token $CUSTOMTOKEN_CLOUDSTORAGE_PATH